# USER.md - Multi-User Support

## 动态用户识别

**当前会话的 SessionKey:** `agent:main:main`

由于飞书插件的路由机制，所有用户共享同一个会话文件。我通过 `deliveryContext.from` 来动态识别当前用户。

**核心机制：**
- **飞书平台提供：** `origin.from` 字段包含实际发送消息的用户 ID
- **系统利用：** 通过检查 `origin.from` 字段动态识别用户
- **识别结果：** 根据用户 ID 从用户配置表查找对应信息

---

## 📋 已知用户

### tech
- **User ID:** `ou_5c7144a360f68b2db0e434749f5a9945`
- **机器人 ID:** `oc_f6d2e6388d34f539dd37a898b6cf00cc`
- **称谓:** tech
- **时区:** Asia/Shanghai (UTC+8)
- **GitHub:** china10s
- **飞书账号:** 未配置（使用默认机器人）
- **飞书昵称:** 未配置
- **创建时间:** 2026-02-08

### wwn
- **User ID:** `ou_725f66654653d6c7061d5f99eb8f4df7`
- **机器人 ID:** `oc_71e0965d0a667df9afb65f9bbcfb4453`
- **称谓:** wwn
- **时区:** Asia/Shanghai (UTC+8)
- **GitHub:** 未配置
- **飞书账号:** 未配置（使用默认机器人）
- **飞书昵称:** 未配置
- **创建时间:** 2026-02-08

---

## 🤖 AI 行为规则

### 🎯 最重要：用户标记机制

**在回复中添加用户标记，帮助用户快速识别当前对话属于谁：**

```javascript
// 用户标记格式
【tech】 - tech 的消息
【wwn】 - wwn 的消息
【unknown】 - 未知用户的消息
```

**规则：**
1. **在回复开头添加用户标记** - 帮助用户立即识别当前对话
2. **标记内容** - 显示当前用户的称谓或标识
3. **视觉效果** - 使用方括号 `【】` 突出显示，吸引注意

### 识别当前用户
每次回复时，我会检查会话的 `origin.from` 字段（来自 `sessions.json`）：
- 如果是 `ou_5c7144a360f68b2db0e434749f5a9945` → 用户是 **tech**
- 如果是 `ou_725f66654653d6c7061d5f99eb8f4df7` → 用户是 **wwn**
- 其他 ID → 识别为新用户，添加标记 `【unknown】`

### 为什么用用户标记？

**好处：**
- ✅ **快速识别** - 用户立即看到标记就知道当前对话是谁
- ✅ **避免混淆** - 即使在共享会话中，也能清楚区分不同用户的对话
- ✅ **无需上下文过滤** - 标记机制比过滤历史记录更直观
- ✅ **临时且有效** - 不需要修改飞书插件或实现复杂的上下文隔离

### 标记示例

**tech 发送消息后的回复：**
```
【tech】你好！我是 tech...
【tech】根据你的问题，我帮你查了一下...
【tech】已完成你的请求...
```

**wwn 发送消息后的回复：**
```
【wwn】你好！我是 wwn...
【wwn】根据你的问题，我帮你处理了...
【wwn】任务已完成...
```

### 回复策略
- **只针对当前用户回复** - 回复内容只与当前用户相关
- **不泄露其他用户** - 提及其他用户时，只说"该用户的消息请查看历史记录"
- **添加标记** - 在回复开头添加 `【当前用户】` 标记

### 隐私保护
- ❌ 不在回复中提及其他用户的任务和设置
- ❌ 不透露其他用户的敏感信息
- ✅ 每个用户只能看到自己的对话标记

---

## 📝 记录规则

### 📁 目录结构
```
memory/
  ├── tech/           # tech 的记忆目录
  │   ├── preferences.md
  │   ├── reminders.md
  │   └── YYYY-MM-DD.md
  └── wwn/            # wwn 的记忆目录
      ├── preferences.md
      ├── reminders.md
      └── YYYY-MM-DD.md
```

### 数据访问规则
**当记录信息时：**
1. 识别当前用户（通过 origin.from）
2. 将信息写入对应用户的文件
3. 不读取其他用户的文件

**隐私保护：**
- ❌ 不在回复中提及其他用户
- ❌ 不读取其他用户的配置文件
- ❌ 不泄露其他用户的信息
- ✅ 只访问和回复当前用户的数据

---

## 🔄 系统状态

### 全局变量
- `CURRENT_USER`: 当前用户 ID
- `CURRENT_USER_CONFIG`: 当前用户配置
- `LAST_USER_ID`: 上一个用户 ID
- `USER_SWITCH_COUNT`: 用户切换次数

### 环境识别
```javascript
const SESSION_KEY = "agent:main:main";

function getCurrentUser() {
  // 从 sessions.json 获取 origin.from
  const session = loadSession(SESSION_KEY);
  return session.origin.from;
}

function identifyUser(userId) {
  // 查找对应用户
  return USER_CONFIG[userId] || { name: "unknown" };
}
```

---

## 🚀 用户标记实现

### 核心逻辑
每次回复前，执行以下步骤：

1. **获取当前用户 ID** - 从 `message.origin.from` 或 `origin.from` 获取
2. **识别用户** - 从 USER_CONFIG 查找对应的配置
3. **生成用户标记** - 根据 userId 生成标记
4. **在回复开头添加标记** - 添加 `【tech】`、`【wwn】` 或 `【unknown】`

### 标记映射表

| 用户ID | 标记 | 称谓 | 时区 | GitHub |
|--------|------|--------|--------|--------|
| `ou_5c7144a360f68b2db0e434749f5a9945` | `【tech】` | tech | Asia/Shanghai | china10s |
| `ou_725f66654653d6c7061d5f99eb8f4df7` | `【wwn】` | wwn | Asia/Shanghai | - |

### 生成函数
```javascript
function generateUserMark(userId) {
  const marks = {
    'ou_5c7144a360f68b2db0e434749f5a9945': '【tech】',
    'ou_725f66654653d6c7061d5f99eb8f4df7': '【wwn】'
  };
  return marks[userId] || '【unknown】';
}
```

---

## ⚠️ 重要约束

### 飞书插件限制
- **会话共享：** 所有 DM 用户共享同一个会话文件
- **路由不可控：** 无法修改飞书插件的路由逻辑
- **ID 可用：** `origin.from` 字段提供了实际用户 ID
- **账户固定：** 配置文件中只有一个 `default` 账户

### 临时方案 vs 长期方案
| 方案 | 优点 | 缺点 |
|------|------|--------|
| **用户标记（当前）** | ✅ 立即可实现 | ⚠️ 视觉上可能有些混乱 |
| **上下文隔离** | ✅ 在回复层面实现 | ⚠️ 其他用户的历史记录仍然在同一个会话文件中 |
| **并发处理** | ✅ 无需 spawn | ⚠️ 串行处理，无法同时处理 |
| **修改飞书插件** | ❌ 不需要 | ✅ 最佳长期方案 |

---

## 🎯 总结

**核心机制：**
1. **动态用户识别：** 基于 `origin.from` 字段动态识别用户
2. **用户标记显示：** 在回复开头添加 `【tech】`、`【wwn】` 或 `【unknown】` 标记
3. **上下文过滤：** 只显示和回复当前用户相关的信息
4. **隐私保护：** 不泄露其他用户的信息

**实现原则：**
- ✅ **快速识别：** 用户标记帮助快速识别当前对话
- ✅ **避免混淆：** 标记机制清楚区分不同用户
- ✅ **易于理解：** 用户立即知道当前对话属于谁
- ✅ **无需修改插件：** 利用现有机制实现用户隔离
- ✅ **灵活扩展：** 可以轻松支持新用户

**tech 和 wwn，你们的动态用户识别和用户标记机制已经完成！** 🎉

**从现在开始，在每次回复中，我都会在开头添加 `【tech】` 或 `【wwn】` 标记，帮助你们快速识别当前对话属于谁！** ✅